- route:
    id: route-c873
    from:
      id: from-db3a
      uri: direct
      parameters:
        name: getArasToken
      steps:
        - setBody:
            id: setBody-7e69
            expression:
              constant:
                id: constant-9570
                expression: >-
                  grant_type=password&scope=openid Innovator
                  offline_access&client_id=InnovatorClient&username=${properties:aras.username}&password=${properties:aras.password}&database=${properties:aras.database}       
        - setHeader:
            id: setHeader-58d3
            name: Content-Type
            expression:
              constant:
                id: constant-082a
                expression: application/x-www-form-urlencoded
        - setHeader:
            id: setHeader-1636
            name: Cookie
            expression:
              constant:
                id: constant-9d0b
                expression: >-
                  Aras.Server.Session=CfDJ8Oizhveh66tFnrQPkReDZ2phGDDXCFwoMlOoJDJu%2BwdpEd9a0tC5WIBSPfWfN3%2F9hMadRq1pzmv4%2FanbkMxYaOUYDiJHKUOfHdN42s2UZ5bGupBmmUmnDbCt3rr%2FUussCxBkPMe3VK4lTNUxx2lfP4I1Ec%2FdzfDOphKLJ%2FdzH%2FkZ
        - toD:
            id: toD-b5cb
            uri: >-
              ${properties:aras.domain}/InnovatorServer/OAuthServer/connect/token
        - unmarshal:
            id: unmarshal-c814
            json:
              id: json-44d8
        - setBody:
            id: setBody-687e
            expression:
              simple:
                id: simple-38db
                expression: ${body[access_token]}
- route:
    id: route-db7f
    from:
      id: from-bc15
      uri: timer
      parameters:
        timerName: period
        period: 60s
      steps:
        - log:
            id: log-eb3f
            message: ðŸš€ Báº¯t Ä‘áº§u chu ká»³ polling dá»¯ liá»‡u tá»« ARAS...
        - to:
            id: to-1e84
            uri: direct
            parameters:
              name: getArasToken
        - setHeader:
            id: setHeader-8cff
            name: Authorization
            expression:
              simple:
                id: simple-6739
                expression: Bearer ${body}
        - setHeader:
            id: setHeader-506e
            name: Cookie
            expression:
              constant:
                id: constant-9589
                expression: ${properties:aras.cookie}
        - toD:
            id: toD-a780
            uri: >-
              ${properties:aras.domain}/InnovatorServer/server/odata/Part?$top=10&$count=false
        - log:
            id: log-8e28
            message: |
              ðŸ§¾ Body nháº­n tá»« ARAS:
              ${body}
        - unmarshal:
            id: unmarshal-9d23
            json:
              id: json-c592
        - setBody:
            id: transform-json
            expression:
              groovy:
                id: groovy-613a
                expression: |
                  def input = exchange.message.body
                  def parts = input.value.collect { it ->
                      [
                          item_code: it.item_number,
                          item_name: it.name,
                          description: it.description,
                          item_group: it.classification,
                          stock_uom: it.unit,
                          is_purchase_item: (it.make_buy == "Buy" ? 1 : 0),
                          disabled: (it.state == "Released" ? 0 : 1),
                          is_stock_item: 1,
                          is_sales_item: 1,
                          include_item_in_manufacturing: 1,
                          allow_negative_stock: 0,
                          country_of_origin: "Vietnam",
                          default_material_request_type: "Purchase",
                          end_of_life: "2099-12-31"
                      ]
                  }
                  return [items: parts]
        - log:
            id: log-transformed
            message: |
              ðŸ”„ Dá»¯ liá»‡u sau khi transform:
              ${body}
        - setHeader:
            id: 1111
            name: Cookie
            expression:
              constant:
                id: constant-79b0
                expression: ${properties:erp.cookie}
        - setHeader:
            id: 2222
            name: Content-Type
            expression:
              constant:
                id: constant-aefd
                expression: application/json
        - marshal:
            id: marshal-e939
            json:
              id: json-de2a
        - toD:
            id: toD-4d63
            uri: ${properties:erp.domain}/api/resource/Item
        - log:
            id: 111111
            message: |
              Gá»¬I THÃ€NH CÃ”NG!!
