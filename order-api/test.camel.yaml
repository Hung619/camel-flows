- rest:
    id: rest-3902
    path: /api/resource
    post:
      - id: post-809d
        path: /Item
        to: direct:fake-erpnext
        consumes: application/json
        produces: application/json
- route:
    id: route-db7f
    from:
      id: from-bc15
      uri: timer
      parameters:
        timerName: period
        period: 60s
      steps:
        - log:
            id: log-eb3f
            message: ðŸš€ Báº¯t Ä‘áº§u chu ká»³ polling dá»¯ liá»‡u tá»« ARAS...
        - to:
            id: to-1e84
            uri: direct
            parameters:
              name: getArasToken
        - setHeader:
            id: setHeader-8cff
            name: Authorization
            expression:
              simple:
                id: simple-6739
                expression: Bearer ${body}
        - setHeader:
            id: setHeader-506e
            name: Cookie
            expression:
              constant:
                id: constant-9589
                expression: >-
                  Aras.Server.Session=CfDJ8Oizhveh66tFnrQPkReDZ2phGDDXCFwoMlOoJDJu%2BwdpEd9a0tC5WIBSPfWfN3%2F9hMadRq1pzmv4%2FanbkMxYaOUYDiJHKUOfHdN42s2UZ5bGupBmmUmnDbCt3rr%2FUussCxBkPMe3VK4lTNUxx2lfP4I1Ec%2FdzfDOphKLJ%2FdzH%2FkZ
        - toD:
            id: toD-a780
            uri: >-
              https://aras.tuilakhanh.id.vn/InnovatorServer/server/odata/Part?$top=10&$count=false
        - log:
            id: log-8e28
            message: |
              ðŸ§¾ Body nháº­n tá»« ARAS:
              ${body}
        - unmarshal:
            id: unmarshal-9d23
            json:
              id: json-c592
        - setBody:
            id: transform-json
            expression:
              groovy:
                id: groovy-613a
                expression: |
                  def input = exchange.message.body
                  def parts = input.value.collect { it ->
                      [
                          item_code: it.item_number,
                          item_name: it.name,
                          description: it.description,
                          item_group: it.classification,
                          stock_uom: it.unit,
                          is_purchase_item: (it.make_buy == "Buy"),
                          is_sales_item: true,
                          disabled: (it.state == "Released" ? 0 : 1)
                      ]
                  }
                  return [items: parts]
        - log:
            id: log-transformed
            message: |
              ðŸ”„ Dá»¯ liá»‡u sau khi transform:
              ${body}
        - setHeader:
            id: setHeader-bc43
            name: Authorization
            expression:
              constant:
                id: constant-43c6
                expression: token YOUR_ERP_API_KEY:YOUR_ERP_API_SECRET
        - setHeader:
            id: setHeader-60b7
            name: Content-Type
            expression:
              constant:
                id: constant-fb1a
                expression: application/json
        - marshal:
            id: marshal-e939
            json:
              id: json-de2a
        - toD:
            id: toD-4d63
            uri: http://localhost:8080/api/resource/Item
- route:
    id: route-c873
    from:
      id: from-2997
      uri: direct
      parameters:
        name: getArasToken
      steps:
        - setBody:
            id: setBody-7e69
            expression:
              constant:
                id: constant-9570
                expression: >-
                  grant_type=password&scope=openid Innovator
                  offline_access&client_id=InnovatorClient&username=admin&password=innovator&database=InnovatorSolutionss
        - setHeader:
            id: setHeader-58d3
            name: Content-Type
            expression:
              constant:
                id: constant-082a
                expression: application/x-www-form-urlencoded
        - setHeader:
            id: setHeader-1636
            name: Cookie
            expression:
              constant:
                id: constant-9d0b
                expression: >-
                  Aras.Server.Session=CfDJ8Oizhveh66tFnrQPkReDZ2phGDDXCFwoMlOoJDJu%2BwdpEd9a0tC5WIBSPfWfN3%2F9hMadRq1pzmv4%2FanbkMxYaOUYDiJHKUOfHdN42s2UZ5bGupBmmUmnDbCt3rr%2FUussCxBkPMe3VK4lTNUxx2lfP4I1Ec%2FdzfDOphKLJ%2FdzH%2FkZ
        - toD:
            id: toD-b5cb
            uri: >-
              https://aras.tuilakhanh.id.vn/InnovatorServer/OAuthServer/connect/token
        - unmarshal:
            id: unmarshal-c814
            json:
              id: json-44d8
        - setBody:
            id: setBody-687e
            expression:
              simple:
                id: simple-38db
                expression: ${body[access_token]}
- route:
    id: route-d9a6
    from:
      id: from-fa4e
      uri: direct
      parameters:
        name: fake-erpnext
      steps:
        - log:
            id: log-f934
            message: |
              ðŸ“¥ [Fake ERPNext] Nháº­n dá»¯ liá»‡u:
              Body: ${body}
              Headers: ${headers}
        - setBody:
            id: setBody-5062
            expression:
              constant:
                id: constant-9bb4
                expression: |
                  {
                    "data": {
                      "message": "Fake ERPNext nháº­n dá»¯ liá»‡u thÃ nh cÃ´ng",
                      "timestamp": "${date:now:yyyy-MM-dd HH:mm:ss}"
                    }
                  }
        - marshal:
            id: marshal-50a4
            json:
              id: json-c08c
