- rest:
    id: rest-3902
    path: /api/resource
    post:
      - id: post-809d
        path: /Item
        to: direct:fake-erpnext
        consumes: application/json
        produces: application/json
- route:
    id: route-db7f
    from:
      id: from-bc15
      uri: timer
      parameters:
        timerName: period
      steps:
        - log:
            id: log-eb3f
            message: 🚀 Bắt đầu chu kỳ polling dữ liệu từ ARAS...
        - to:
            id: to-1e84
            uri: direct
            parameters:
              name: getArasToken
        - setHeader:
            id: setHeader-8cff
            name: Authorization
            expression:
              simple:
                id: simple-bc19
                expression: Bearer ${body}
        - setHeader:
            id: setHeader-506e
            name: Cookie
            expression:
              constant:
                id: constant-7e55
                expression: >-
                  Aras.Server.Session=CfDJ8Oizhveh66tFnrQPkReDZ2phGDDXCFwoMlOoJDJu%2BwdpEd9a0tC5WIBSPfWfN3%2F9hMadRq1pzmv4%2FanbkMxYaOUYDiJHKUOfHdN42s2UZ5bGupBmmUmnDbCt3rr%2FUussCxBkPMe3VK4lTNUxx2lfP4I1Ec%2FdzfDOphKLJ%2FdzH%2FkZ
        - log:
            id: log-55fb
            message: "📤 Headers gửi sang ARAS: ${headers}"
        - toD:
            id: toD-a780
            uri: >-
              https://aras.tuilakhanh.id.vn/InnovatorServer/server/odata/Part?$top=10&$count=false
        - log:
            id: log-8e28
            message: |
              🧾 Body nhận từ ARAS:
              ${body}
        - split:
            id: split-eb96
            expression:
              jsonpath:
                id: jsonpath-50e4
                expression: $.value[*]
            steps:
              - marshal:
                  id: marshal-b1bd
                  json:
                    id: json-d3d3
                    library: Jackson
              - log:
                  id: log-c573
                  message: "Đang xử lý Part: ${body}"
              - toD:
                  id: toD-99e3
                  uri: atlasmap:aras-to-erpnext.adm
              - setHeader:
                  id: setHeader-bc43
                  name: Authorization
                  expression:
                    constant:
                      id: constant-fa88
                      expression: token YOUR_ERP_API_KEY:YOUR_ERP_API_SECRET
              - setHeader:
                  id: setHeader-60b7
                  name: Content-Type
                  expression:
                    constant:
                      id: constant-d043
                      expression: application/json
              - toD:
                  id: toD-4d63
                  uri: http://localhost:8080/api/resource/Item
- route:
    id: route-c873
    from:
      id: from-2ca0
      uri: direct
      parameters:
        name: getArasToken
      steps:
        - setBody:
            id: setBody-6e68
            expression:
              constant:
                id: constant-9936
                expression: >-
                  grant_type=password&scope=openid Innovator
                  offline_access&client_id=InnovatorClient&username=admin&password=innovator&database=InnovatorSolutionss
        - setHeader:
            id: setHeader-572f
            name: Content-Type
            expression:
              constant:
                id: constant-e396
                expression: application/x-www-form-urlencoded
        - setHeader:
            id: setHeader-ea94
            name: Cookie
            expression:
              constant:
                id: constant-ee25
                expression: >-
                  Aras.Server.Session=CfDJ8Oizhveh66tFnrQPkReDZ2phGDDXCFwoMlOoJDJu%2BwdpEd9a0tC5WIBSPfWfN3%2F9hMadRq1pzmv4%2FanbkMxYaOUYDiJHKUOfHdN42s2UZ5bGupBmmUmnDbCt3rr%2FUussCxBkPMe3VK4lTNUxx2lfP4I1Ec%2FdzfDOphKLJ%2FdzH%2FkZ
        - toD:
            id: toD-e320
            uri: >-
              https://aras.tuilakhanh.id.vn/InnovatorServer/OAuthServer/connect/token
        - unmarshal:
            id: unmarshal-f05f
            json:
              id: json-1d44
              library: Jackson
        - setBody:
            id: setBody-4066
            expression:
              simple:
                id: simple-c5d5
                expression: ${body[access_token]}
- route:
    id: route-d9a6
    from:
      id: from-4fb3
      uri: direct
      parameters:
        name: fake-erpnext
      steps:
        - log:
            id: log-1bf8
            message: |
              📥 [Fake ERPNext] Nhận dữ liệu:
              Body: ${body}
              Headers: ${headers}
        - setBody:
            id: setBody-ef5f
            expression:
              constant:
                id: constant-5b92
                expression: |
                  {
                    "data": {
                      "message": "Fake ERPNext nhận dữ liệu thành công",
                      "timestamp": "${date:now:yyyy-MM-dd HH:mm:ss}"
                    }
                  }
        - marshal:
            id: marshal-b1c9
            json:
              id: json-794a
              library: Jackson
