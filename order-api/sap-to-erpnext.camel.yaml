- route:
    id: sap-material-to-erpnext
    from:
      id: from-sap-material
      uri: platform-http
      parameters:
        httpMethodRestrict: POST
        consumes: application/json
        path: /api/sap/material
      steps:
        - log:
            id: log-material-received
            message: "Nhận Material từ SAP: ${body}"
        - log:
            id: log-0303
            message: ${header.CamelVertxPlatformHttpRemoteAddress}
        - unmarshal:
            id: unmarshal-5c8c
            json:
              id: json-1e14
        - removeHeaders:
            id: removeHeaders-515a
            pattern: "*"
        - transform:
            id: transform-material-groovy
            expression:
              groovy:
                id: groovy-bcb7
                expression: |
                  def sapData = request.body

                  def uomMap = [
                      "PC": "Nos",
                      "KG": "Kg",
                      "ST": "Nos"
                  ]

                  def erpNextData = [
                      item_code:       sapData.code ?: null,
                      item_name:       sapData.name ?: "Unknown Item Name",
                      is_stock_item:   (sapData.active ?: "0").toInteger(),
                      item_group:      "Products"
                  ]

                  return erpNextData
        - setProperty:
            id: setProperty-material-body
            name: materialBody
            expression:
              simple:
                id: simple-material-body
                expression: ${body}
        - marshal:
            id: marshal-d999
            json:
              id: json-66c7
        - setProperty:
            id: setProperty-material-json
            name: materialJson
            expression:
              simple:
                id: simple-material-json
                expression: ${body}
        - setHeaders:
            id: setHeaders-staging
            headers:
              - id: setHeader-staging-content
                name: Content-Type
                expression:
                  constant:
                    id: constant-staging-content
                    expression: application/json
              - id: setHeader-staging-method
                name: CamelHttpMethod
                expression:
                  constant:
                    id: constant-staging-method
                    expression: POST
              - id: setHeader-staging-auth
                name: Authorization
                expression:
                  constant:
                    id: constant-staging-auth
                    expression: token c61c06703d10a9d:833ed41aa1bde0d
        - log:
            id: log-staging-request
            message: "Sending to STAGING: ${body}"
        - to:
            id: to-staging-material
            uri: https
            parameters:
              bridgeEndpoint: true
              throwExceptionOnFailure: false
              httpUri: stg-erpnext.imespro.ai/api/resource/Item
        - setProperty:
            id: setProperty-staging-response
            name: stagingResponse
            expression:
              simple:
                id: simple-staging-resp
                expression: ${body}
        - setProperty:
            id: setProperty-staging-code
            name: stagingCode
            expression:
              simple:
                id: simple-staging-code
                expression: ${header.CamelHttpResponseCode}
        - log:
            id: log-staging-response
            message: "STAGING Response [${header.CamelHttpResponseCode}]: ${body}"
        - removeHeaders:
            id: removeHeaders-before-prod
            pattern: "*"
        - setBody:
            id: setBody-reset-prod
            expression:
              simple:
                id: simple-reset-prod
                expression: ${exchangeProperty.materialJson}
        - setHeaders:
            id: setHeaders-prod
            headers:
              - id: setHeader-prod-content
                name: Content-Type
                expression:
                  constant:
                    id: constant-prod-content
                    expression: application/json
              - id: setHeader-prod-method
                name: CamelHttpMethod
                expression:
                  constant:
                    id: constant-prod-method
                    expression: POST
              - id: setHeader-prod-auth
                name: Authorization
                expression:
                  constant:
                    id: constant-prod-auth
                    expression: token 64eeba83a203ea2:5f09dfce527378b
        - log:
            id: log-prod-request
            message: "Sending to PRODUCTION: ${body}"
        - to:
            id: to-prod-material
            uri: https
            parameters:
              bridgeEndpoint: true
              throwExceptionOnFailure: false
              httpUri: tecomen.imespro.ai/api/resource/Item
        - setProperty:
            id: setProperty-prod-response
            name: prodResponse
            expression:
              simple:
                id: simple-prod-resp
                expression: ${body}
        - setProperty:
            id: setProperty-prod-code
            name: prodCode
            expression:
              simple:
                id: simple-prod-code
                expression: ${header.CamelHttpResponseCode}
        - log:
            id: log-prod-response
            message: "PRODUCTION Response [${header.CamelHttpResponseCode}]: ${body}"
        - setBody:
            id: setBody-material-final
            expression:
              simple:
                id: simple-material-final-body
                expression: ${exchangeProperty.prodResponse}
        - setHeader:
            id: setHeader-final-content
            name: Content-Type
            expression:
              constant:
                id: constant-final-content
                expression: application/json
- route:
    id: route-sap-bom-sync
    from:
      id: from-sap-bom
      uri: platform-http
      parameters:
        path: /api/sap/bom
        httpMethodRestrict: POST
        consumes: application/json
      steps:
        - log:
            id: log-bom-received
            message: "Nhận BOM từ SAP: ${body}"
        - unmarshal:
            id: unmarshal-bom
            json:
              id: json-bom-unmarshal
        - setProperty:
            id: setProperty-sap-raw-data
            name: sapRawData
            expression:
              simple:
                id: simple-sap-raw
                expression: ${body}
        - removeHeaders:
            id: removeHeaders-bom
            pattern: "*"
        - transform:
            id: transform-bom-groovy
            expression:
              groovy:
                id: groovy-bom-transform
                expression: |
                  def sapData = request.body
                  def stripAll = { s -> s.replaceFirst("^0+", "") }

                  def erpnextPayload = [
                    item: stripAll(sapData.bomnumber),
                    quantity: sapData.baseqty?.trim()?.toFloat() ?: 1,
                    uom: 'PC',
                    items: []
                  ]

                  sapData.items?.each { item ->
                    erpnextPayload.items << [
                      item_code: stripAll(item.component),
                      qty: item.quantity?.trim()?.toFloat() ?: 0
                    ]
                  }

                  return erpnextPayload
        - marshal:
            id: marshal-bom
            json:
              id: json-bom-marshal
        - setProperty:
            id: setProperty-bom-json
            name: bomJson
            expression:
              simple:
                id: simple-bom-json
                expression: ${body}
        - setHeaders:
            id: setHeaders-bom-staging
            headers:
              - id: setHeader-bom-staging-content
                name: Content-Type
                expression:
                  constant:
                    id: constant-bom-staging-content
                    expression: application/json
              - id: setHeader-bom-staging-method
                name: CamelHttpMethod
                expression:
                  constant:
                    id: constant-bom-staging-method
                    expression: POST
              - id: setHeader-bom-staging-auth
                name: Authorization
                expression:
                  constant:
                    id: constant-bom-staging-auth
                    expression: token c61c06703d10a9d:833ed41aa1bde0d
        - log:
            id: log-bom-staging-request
            message: "BOM to STAGING: ${body}"
        - to:
            id: to-bom-staging
            uri: https
            parameters:
              bridgeEndpoint: true
              throwExceptionOnFailure: false
              httpUri: stg-erpnext.imespro.ai/api/resource/BOM
        - setProperty:
            id: setProperty-bom-staging-response
            name: bomStagingResponse
            expression:
              simple:
                id: simple-bom-staging-resp
                expression: ${body}
        - setProperty:
            id: setProperty-bom-staging-code
            name: bomStagingCode
            expression:
              simple:
                id: simple-bom-staging-code
                expression: ${header.CamelHttpResponseCode}
        - log:
            id: log-bom-staging-response
            message: "BOM STAGING Response [${header.CamelHttpResponseCode}]: ${body}"
        - removeHeaders:
            id: removeHeaders-bom-prod
            pattern: "*"
        - setBody:
            id: setBody-bom-reset-prod
            expression:
              simple:
                id: simple-bom-reset-prod
                expression: ${exchangeProperty.bomJson}
        - setHeaders:
            id: setHeaders-bom-prod
            headers:
              - id: setHeader-bom-prod-content
                name: Content-Type
                expression:
                  constant:
                    id: constant-bom-prod-content
                    expression: application/json
              - id: setHeader-bom-prod-method
                name: CamelHttpMethod
                expression:
                  constant:
                    id: constant-bom-prod-method
                    expression: POST
              - id: setHeader-bom-prod-auth
                name: Authorization
                expression:
                  constant:
                    id: constant-bom-prod-auth
                    expression: token 64eeba83a203ea2:5f09dfce527378b
        - log:
            id: log-bom-prod-request
            message: "BOM to PRODUCTION: ${body}"
        - to:
            id: to-bom-prod
            uri: https
            parameters:
              bridgeEndpoint: true
              throwExceptionOnFailure: false
              httpUri: tecomen.imespro.ai/api/resource/BOM
        - setProperty:
            id: setProperty-bom-prod-response
            name: bomProdResponse
            expression:
              simple:
                id: simple-bom-prod-resp
                expression: ${body}
        - setProperty:
            id: setProperty-bom-prod-code
            name: bomProdCode
            expression:
              simple:
                id: simple-bom-prod-code
                expression: ${header.CamelHttpResponseCode}
        - log:
            id: log-bom-prod-response
            message: "BOM PRODUCTION Response [${header.CamelHttpResponseCode}]: ${body}"
        - setBody:
            id: setBody-bom-final
            expression:
              groovy:
                id: groovy-bom-final
                expression: |
                  def prodCode = exchange.getProperty('bomProdCode')
                  def prodResp = exchange.getProperty('bomProdResponse')
                  def sapData = exchange.getProperty('sapRawData')

                  def prodSuccess = (prodCode == '200' || prodCode == '201')

                  if (prodSuccess) {
                      return [
                          objecttype: 'BOM',
                          objectcode: sapData?.bomnumber ?: '',
                          flag: 'S',
                          message: "BOM created successfully",
                          sessionid: exchange.exchangeId
                      ]
                  } else {
                      def errorMsg = prodResp ?: 'Unknown error'
                      return [
                          objecttype: 'BOM',
                          objectcode: sapData?.bomnumber ?: '',
                          flag: 'E',
                          message: "Failed to create BOM. HTTP Code: ${prodCode}. Error: ${errorMsg}",
                          sessionid: exchange.exchangeId
                      ]
                  }
        - marshal:
            id: marshal-bom-final
            json:
              id: json-bom-final
        - log:
            id: log-bom-final-response
            message: "BOM Response to SAP (from Production): ${body}"
- route:
    id: route-sap-production-order
    from:
      id: from-production-order
      uri: platform-http
      parameters:
        httpMethodRestrict: POST
        consumes: application/json
        path: /api/sap/production-order
      steps:
        - log:
            id: log-po-received
            message: "Nhận dữ liệu từ SAP: ${body}"
        - unmarshal:
            id: unmarshal-po
            json:
              id: json-po-unmarshal
        - removeHeaders:
            id: removeHeaders-po-initial
            pattern: "*"
        - transform:
            id: transform-po-groovy
            expression:
              groovy:
                id: groovy-po-transform
                expression: |
                  def sapData = request.body
                  exchange.setProperty("sapRawData", sapData)
                  def stripAll = { s -> s.replaceFirst("^0+", "") }
                  def uomMap = [
                      "PC": "Nos",
                      "KG": "Kg",
                      "ST": "Nos",
                      "M": "Nos"
                  ]

                  def erpPoItems = [[
                      item_code: stripAll(sapData.material),
                      sap_bom_no: stripAll(sapData.bomid),
                      planned_qty: sapData.orderquantity,
                      planned_start_date: sapData.startDate
                  ]]

                  exchange.setProperty("poItems", erpPoItems)

                  def erpNextData = [
                      total_planned_qty: sapData.orderquantity,
                      name: stripAll(sapData.productionorder),
                      po_items: erpPoItems
                  ]

                  return erpNextData
        - setProperty:
            id: setProperty-po-erpnext
            name: PoErpnext
            expression:
              simple:
                id: simple-po-erpnext
                expression: ${body}
        - marshal:
            id: marshal-po
            json:
              id: json-po-marshal
        - setProperty:
            id: setProperty-po-json
            name: poJson
            expression:
              simple:
                id: simple-po-json
                expression: ${body}
        - setHeaders:
            id: setHeaders-po-staging
            headers:
              - id: setHeader-po-staging-content
                name: Content-Type
                expression:
                  constant:
                    id: constant-po-staging-content
                    expression: application/json
              - id: setHeader-po-staging-method
                name: CamelHttpMethod
                expression:
                  constant:
                    id: constant-po-staging-method
                    expression: POST
              - id: setHeader-po-staging-auth
                name: Authorization
                expression:
                  constant:
                    id: constant-po-staging-auth
                    expression: token c61c06703d10a9d:833ed41aa1bde0d
        - log:
            id: log-po-staging-request
            message: "Production Plan to STAGING: ${body}"
        - to:
            id: to-po-staging
            uri: https
            parameters:
              bridgeEndpoint: true
              throwExceptionOnFailure: false
              httpUri: >-
                stg-erpnext.imespro.ai/api/method/imes.api.production_plan.production_plan
        - setProperty:
            id: setProperty-po-staging-response
            name: poStagingResponse
            expression:
              simple:
                id: simple-po-staging-resp
                expression: ${body}
        - setProperty:
            id: setProperty-po-staging-code
            name: poStagingCode
            expression:
              simple:
                id: simple-po-staging-code
                expression: ${header.CamelHttpResponseCode}
        - log:
            id: log-po-staging-response
            message: >-
              Production Plan STAGING Response
              [${header.CamelHttpResponseCode}]: ${body}
        - removeHeaders:
            id: removeHeaders-po-prod
            pattern: "*"
        - setBody:
            id: setBody-po-reset-prod
            expression:
              simple:
                id: simple-po-reset-prod
                expression: ${exchangeProperty.poJson}
        - setHeaders:
            id: setHeaders-po-prod
            headers:
              - id: setHeader-po-prod-content
                name: Content-Type
                expression:
                  constant:
                    id: constant-po-prod-content
                    expression: application/json
              - id: setHeader-po-prod-method
                name: CamelHttpMethod
                expression:
                  constant:
                    id: constant-po-prod-method
                    expression: POST
              - id: setHeader-po-prod-auth
                name: Authorization
                expression:
                  constant:
                    id: constant-po-prod-auth
                    expression: token 64eeba83a203ea2:5f09dfce527378b
        - log:
            id: log-po-prod-request
            message: "Production Plan to PRODUCTION: ${body}"
        - to:
            id: to-po-prod
            uri: https
            parameters:
              bridgeEndpoint: true
              throwExceptionOnFailure: false
              httpUri: >-
                tecomen.imespro.ai/api/method/imes.api.production_plan.production_plan
        - setProperty:
            id: setProperty-po-prod-response
            name: poProdResponse
            expression:
              simple:
                id: simple-po-prod-resp
                expression: ${body}
        - setProperty:
            id: setProperty-po-prod-code
            name: poProdCode
            expression:
              simple:
                id: simple-po-prod-code
                expression: ${header.CamelHttpResponseCode}
        - log:
            id: log-po-prod-response
            message: >-
              Production Plan PRODUCTION Response
              [${header.CamelHttpResponseCode}]: ${body}
        - setBody:
            id: setBody-po-final
            expression:
              simple:
                id: simple-po-final-body
                expression: ${exchangeProperty.poProdResponse}
        - setHeader:
            id: setHeader-po-final-content
            name: Content-Type
            expression:
              constant:
                id: constant-po-final-content
                expression: application/json
